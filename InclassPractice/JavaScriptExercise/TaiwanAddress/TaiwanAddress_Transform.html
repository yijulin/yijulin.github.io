<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <title>Hello, world!</title>
</head>

<body>
    <!-- # Github -- Taiwan City Address : https://github.com/donma/TaiwanAddressCityAreaRoadChineseEnglishJSON -->
    <div class="jumbotron">
        <h1>郵遞區號JSON資料格式轉換</h1>
        <p>
            [
            {
            "City": "臺北市",
            "Districts": [
            {
            "District": "中正區",
            "ZipCode": "100"
            },
            {
            "District": "大同區",
            "ZipCode": "103"
            },
            ...
            ]
            },
            ...
            ]
        </p>
    </div>
    <button id='xhr'>以XHR讀取網路郵遞區號JSON檔</button>
    <button id='fetch'>以Fetch讀取網路郵遞區號JSON檔</button>
    <button id='transform' disabled>解析並轉換資料</button>
    <ul id='result'></ul>
    <div id='msg'></div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    <script type='module'>
        import { qselect, create } from '../../../helpers.js';

        let msg = qselect("#msg");
        let result = qselect("#result");
        qselect('#xhr').addEventListener('click', getAddressJSON);

        let zipcodeArray = []; //原始
        let zipcodeNewArray = []; //轉換後的
        let jsonUrl = 'https://raw.githubusercontent.com/apprunner/FileStorage/master/TaiwanAddress.json';
        let idx = 1;

        let xhr = new XMLHttpRequest();
        function getAddressJSON() {

            xhr.onload = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    zipcodeArray = JSON.parse(this.responseText);
                    console.log(zipcodeArray);

                    show();
                } else {
                    msg.innerText = '發⽣生錯誤，HTTP response代碼：' + xhr.status;
                }

            }
            xhr.open('GET', jsonUrl);
            xhr.send();

            qselect("#transform").disabled = false;
        }
        function show() {
            msg.innerHTML = "";
            result.innerHTML = ""
            idx = 1;
            zipcodeArray.forEach((city, index) => {

                city.AreaList.forEach((district, index) => {
                    let cityno = idx.toString().padStart(3, "0") + "," + city.CityName;
                    let address = cityno + "," + district.AreaName + "," + district.ZipCode;
                    let li = create("li", address);
                    result.appendChild(li);
                    idx++;
                });
            });
        }

        qselect('#fetch').addEventListener('click', fetchJSON);
        function fetchJSON() {
            fetch(jsonUrl)
                .then(response => response.text())
                .then(result => {
                    zipcodeArray = JSON.parse(result);

                    console.log(zipcodeArray);
                    show();
                    qselect("#transform").disabled = false;
                })
                .catch(ex => {
                    msg.innerHTML = ex;
                })
                .finally(() => {

                });
        }



        qselect('#transform').addEventListener('click', TransformData);

        //解析並轉換資料=> City:"臺北市", Districts:[{District:"中正區", ZipCode:"100"}, {}...] 
        function TransformData() {
            zipcodeNewArray = [];

            zipcodeArray.forEach((city, index) => {
                let _city = city.CityName;
                let _districts = [];

                city.AreaList.forEach((arealist) => {
                    _districts.push({ district: arealist.AreaName, zipcode: arealist.ZipCode });
                });

                zipcodeNewArray.push({ city: _city, districts: _districts });


            });
            console.log(zipcodeNewArray);
            qselect("ul").innerHTML = "";
            qselect("#msg").innerHTML = JSON.stringify(zipcodeNewArray);

        }
    </script>
</body>

</html>